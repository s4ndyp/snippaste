<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CodeVault - Cloud Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#0B0F19' }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <style>
        :root { --bg-code: #111827; }
        .theme-code-bg { background-color: var(--bg-code) !important; transition: background-color 0.3s ease; }
        pre code.hljs { background-color: var(--bg-code) !important; border-radius: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        
        .snippet-card.expanded .snippet-content { display: block; }
        .snippet-content { display: none; }
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #10B981; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100;
            left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }
        #toast.show { visibility: visible; opacity: 1; }
        .filter-item.active { background-color: #374151; color: white; border-right: 3px solid #6366f1; }
        
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 100%; 
            background-color: #1f2937; min-width: 160px; z-index: 100; border-radius: 0.5rem;
            border: 1px solid #374151; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }
        .dropdown-content.show { display: block; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 font-sans antialiased min-h-screen flex flex-col overflow-hidden">

    <nav class="bg-gray-900 border-b border-gray-800 p-4 shrink-0 h-[70px]">
        <div class="max-w-[1600px] mx-auto flex justify-between items-center h-full">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-code text-indigo-500 text-2xl"></i>
                <h1 class="text-xl font-bold text-white tracking-wide">Code<span class="text-indigo-500">Vault</span></h1>
                <div id="connection-status" class="ml-4 flex items-center gap-2 px-2 py-1 rounded bg-gray-800 border border-gray-700 text-gray-400 text-[10px] font-mono uppercase">
                    <i class="fa-solid fa-circle text-green-500 text-[8px]"></i> Online
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleThemeDropdown()" class="text-gray-400 hover:text-white px-3 py-1.5 rounded-lg border border-gray-800 relative flex items-center gap-2 text-xs">
                    <i class="fa-solid fa-palette text-indigo-400"></i> Thema
                    <div id="theme-dropdown" class="dropdown-content mt-2">
                        <button onclick="setTheme('#111827')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-xs">Standaard</button>
                        <button onclick="setTheme('#0f172a')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-xs">Midnight</button>
                        <button onclick="setTheme('#000000')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-xs">Deep Black</button>
                    </div>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-[1600px] mx-auto w-full p-6 grid grid-cols-12 gap-6 h-[calc(100vh-70px)] overflow-hidden">
        
        <div class="col-span-3 flex flex-col h-full bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-800 bg-gray-850 font-bold text-[10px] uppercase text-gray-500 tracking-widest flex justify-between items-center">
                <span>Bibliotheek</span>
                <button onclick="openTagManager()" class="hover:text-indigo-400 transition-colors"><i class="fa-solid fa-tags"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-3 space-y-6">
                <div class="space-y-1">
                    <button onclick="setFilter('all')" id="filter-all" class="filter-item w-full flex justify-between px-3 py-2 rounded-lg text-sm transition-all active">
                        <span><i class="fa-solid fa-layer-group mr-3 opacity-50"></i>Alle Snippets</span>
                        <span id="count-all" class="text-[10px] bg-gray-800 px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button onclick="setFilter('favorites')" id="filter-favorites" class="filter-item w-full flex justify-between px-3 py-2 rounded-lg text-sm transition-all text-gray-400">
                        <span><i class="fa-solid fa-star mr-3 text-yellow-500"></i>Favorieten</span>
                        <span id="count-favorites" class="text-[10px] bg-gray-800 px-2 py-0.5 rounded-full">0</span>
                    </button>
                </div>
                <div>
                    <h3 class="text-[10px] font-bold text-gray-600 uppercase mb-3 px-2 tracking-widest">Populaire Tags</h3>
                    <div id="tag-cloud" class="flex flex-wrap gap-2 px-1"></div>
                </div>
            </div>
        </div>

        <div class="col-span-6 flex flex-col h-full overflow-hidden">
            <div class="bg-gray-900 p-2 rounded-xl border border-gray-800 flex items-center gap-3 mb-4 shrink-0 shadow-lg">
                <div class="flex-grow relative">
                    <i class="fa-solid fa-search text-gray-500 absolute left-3 top-1/2 -translate-y-1/2 text-sm"></i>
                    <input type="text" id="search-bar" placeholder="Zoek op titel, code of #tag..." class="w-full bg-gray-800 border-none rounded-lg pl-10 pr-4 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500/50 transition-all">
                </div>
            </div>
            <div id="snippets-container" class="flex-grow overflow-y-auto space-y-4 pr-2 pb-10"></div>
        </div>

        <div class="col-span-3 bg-gray-900 rounded-xl border border-gray-800 p-5 flex flex-col h-full overflow-hidden shadow-2xl">
            <h2 id="form-title" class="text-md font-bold text-white mb-4 border-b border-gray-800 pb-3 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle text-indigo-500"></i> Nieuwe Snippet
            </h2>
            <form id="snippet-form" class="space-y-4 flex flex-col h-full overflow-hidden">
                <input type="hidden" id="snippet-id">
                <div class="shrink-0">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1 tracking-widest">Titel</label>
                    <input type="text" id="title" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 text-sm text-white focus:border-indigo-500 outline-none transition-all" placeholder="Bijv. Express Server Setup" required>
                </div>
                <div class="shrink-0">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1 tracking-widest">Labels (Tags)</label>
                    <input type="text" id="tags" placeholder="js, backend, auth..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 text-sm text-white focus:border-indigo-500 outline-none transition-all">
                </div>
                <div id="input-blocks-container" class="flex-grow overflow-y-auto space-y-4 py-2 custom-scrollbar"></div>
                <button type="button" onclick="addInputBlock()" class="shrink-0 w-full py-3 border-2 border-dashed border-gray-800 text-gray-500 rounded-xl hover:border-indigo-500/50 hover:text-indigo-400 text-[10px] font-bold uppercase transition-all">
                    <i class="fa-solid fa-plus mr-1"></i> Codeblok Toevoegen
                </button>
                <div class="flex gap-2 shrink-0 pt-4 border-t border-gray-800">
                    <button type="submit" class="flex-grow bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl text-sm shadow-lg shadow-indigo-900/20 transition-all active:scale-95">
                        <i class="fa-solid fa-save mr-2"></i> Opslaan
                    </button>
                    <button type="button" id="cancel-edit-btn" onclick="cancelEdit()" class="hidden px-5 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl transition-all">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <div id="toast"></div>

    <script type="module">
        import OfflineManager from './offline_manager.js';

        const CONFIG = {
            API_BASE_URL: 'http://10.10.2.20:5000',
            CLIENT_ID: 'sandman',
            APP_NAME: 'codevault',
            COLLECTION: 'snippets'
        };

        const manager = new OfflineManager(CONFIG.API_BASE_URL, CONFIG.CLIENT_ID, CONFIG.APP_NAME);
        let snippets = [];
        let currentFilter = 'all';
        let searchQuery = '';

        // Tag Kleuren (Originele logica)
        const tagColors = [
            { bg: 'bg-indigo-500/10', text: 'text-indigo-400', border: 'border-indigo-500/20' },
            { bg: 'bg-emerald-500/10', text: 'text-emerald-400', border: 'border-emerald-500/20' },
            { bg: 'bg-amber-500/10', text: 'text-amber-400', border: 'border-amber-500/20' },
            { bg: 'bg-rose-500/10', text: 'text-rose-400', border: 'border-rose-500/20' },
            { bg: 'bg-sky-500/10', text: 'text-sky-400', border: 'border-sky-500/20' }
        ];

        function getTagColor(tag) {
            let hash = 0;
            for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash);
            return tagColors[Math.abs(hash) % tagColors.length];
        }

        async function init() {
            await refreshData();
            addInputBlock();
            document.getElementById('search-bar').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderSnippets();
            });
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();
        }

        function updateStatus() {
            const el = document.getElementById('connection-status');
            el.innerHTML = navigator.onLine ? 
                '<i class="fa-solid fa-circle text-green-500 text-[8px]"></i> Online' : 
                '<i class="fa-solid fa-circle text-red-500 text-[8px]"></i> Offline';
        }

        async function refreshData() {
            snippets = await manager.getSmartCollection(CONFIG.COLLECTION);
            renderSnippets();
            renderTags();
        }

        window.renderSnippets = function() {
            const container = document.getElementById('snippets-container');
            container.innerHTML = '';

            const filtered = snippets.filter(s => {
                const searchStr = (s.title + ' ' + s.tags.join(' ') + ' ' + s.blocks.map(b => b.code).join(' ')).toLowerCase();
                const matchesSearch = searchStr.includes(searchQuery);
                const matchesFilter = currentFilter === 'all' || (currentFilter === 'favorites' && s.favorite);
                return matchesSearch && matchesFilter;
            });

            filtered.forEach(s => container.appendChild(createSnippetCard(s)));
            
            document.getElementById('count-all').textContent = snippets.length;
            document.getElementById('count-favorites').textContent = snippets.filter(s => s.favorite).length;
            hljs.highlightAll();
        };

        function createSnippetCard(s) {
            const div = document.createElement('div');
            div.className = 'snippet-card bg-gray-900 border border-gray-800 rounded-xl overflow-hidden hover:border-gray-700 transition-all shadow-lg group';
            
            const blocksHtml = s.blocks.map((block, idx) => `
                <div class="mt-4 first:mt-0 bg-gray-950 rounded-lg border border-gray-800 overflow-hidden shadow-inner">
                    <div class="bg-gray-850 px-4 py-2 flex justify-between items-center border-b border-gray-800/50">
                        <span class="text-[10px] font-mono text-gray-500 uppercase tracking-widest">${block.language || 'text'}</span>
                        <button onclick="event.stopPropagation(); copyToClipboard(this, \`${block.code.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" 
                                class="text-gray-600 hover:text-indigo-400 transition-all p-1">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                    <pre class="p-4 text-xs theme-code-bg overflow-x-auto"><code class="language-${block.language}">${escapeHtml(block.code)}</code></pre>
                </div>
            `).join('');

            div.innerHTML = `
                <div class="p-4 cursor-pointer" onclick="this.parentElement.classList.toggle('expanded')">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-2">
                                <h3 class="font-bold text-white text-md group-hover:text-indigo-400 transition-colors">${s.title}</h3>
                                <i class="fa-solid fa-chevron-down text-[10px] text-gray-600 group-hover:text-gray-400 transition-transform"></i>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${s.tags.map(t => {
                                    const c = getTagColor(t);
                                    return `<span class="text-[9px] ${c.bg} ${c.text} ${c.border} border px-2 py-0.5 rounded-md font-bold uppercase tracking-tighter">#${t}</span>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="flex gap-1 ml-4 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); toggleFavorite('${s._id}')" class="p-2 ${s.favorite ? 'text-yellow-500' : 'text-gray-600 hover:text-yellow-500'}"><i class="fa-solid fa-star"></i></button>
                            <button onclick="event.stopPropagation(); editSnippet('${s._id}')" class="p-2 text-gray-600 hover:text-blue-400"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="event.stopPropagation(); deleteSnippet('${s._id}')" class="p-2 text-gray-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="snippet-content mt-4 pt-4 border-t border-gray-800/50">
                        ${blocksHtml}
                    </div>
                </div>
            `;
            return div;
        }

        window.renderTags = function() {
            const cloud = document.getElementById('tag-cloud');
            const allTags = [...new Set(snippets.flatMap(s => s.tags))];
            cloud.innerHTML = allTags.map(t => {
                const c = getTagColor(t);
                return `<button onclick="setSearch('#${t}')" class="${c.bg} ${c.text} ${c.border} border px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase hover:scale-105 transition-transform">#${t}</button>`;
            }).join('');
        };

        // --- ACTIONS ---

        window.toggleFavorite = async function(id) {
            const s = snippets.find(item => item._id === id);
            if (!s) return;
            s.favorite = !s.favorite;
            await manager.saveSmartDocument(CONFIG.COLLECTION, s);
            renderSnippets();
            showToast(s.favorite ? "Favoriet toegevoegd" : "Favoriet verwijderd");
        };

        window.copyToClipboard = (btn, text) => {
            navigator.clipboard.writeText(text).then(() => {
                const icon = btn.querySelector('i');
                icon.className = 'fa-solid fa-check text-emerald-500';
                showToast("Code gekopieerd!");
                setTimeout(() => icon.className = 'fa-regular fa-copy', 2000);
            });
        };

        window.setSearch = (val) => {
            const input = document.getElementById('search-bar');
            input.value = val;
            searchQuery = val.toLowerCase();
            renderSnippets();
        };

        document.getElementById('snippet-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('snippet-id').value;
            const data = {
                title: document.getElementById('title').value,
                tags: document.getElementById('tags').value.split(',').map(t => t.trim().toLowerCase()).filter(t => t),
                blocks: Array.from(document.querySelectorAll('.code-block')).map(b => ({
                    language: b.querySelector('select').value,
                    code: b.querySelector('textarea').value
                })),
                favorite: id ? snippets.find(s => s._id === id)?.favorite : false
            };
            if (id) data._id = id;
            
            await manager.saveSmartDocument(CONFIG.COLLECTION, data);
            cancelEdit();
            await refreshData();
            showToast("Snippet veilig opgeslagen");
        };

        window.addInputBlock = function(val = {language: 'javascript', code: ''}) {
            const container = document.getElementById('input-blocks-container');
            const div = document.createElement('div');
            div.className = 'code-block space-y-2 p-3 bg-gray-850 rounded-xl border border-gray-700 shadow-sm';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <select class="bg-gray-800 border-none rounded text-[10px] font-bold text-gray-400 px-2 py-1 outline-none focus:ring-1 focus:ring-indigo-500">
                        <option value="javascript" ${val.language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                        <option value="python" ${val.language === 'python' ? 'selected' : ''}>Python</option>
                        <option value="html" ${val.language === 'html' ? 'selected' : ''}>HTML/CSS</option>
                        <option value="bash" ${val.language === 'bash' ? 'selected' : ''}>Bash/Terminal</option>
                    </select>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-gray-600 hover:text-red-500 text-xs"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <textarea class="w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-xs font-mono text-indigo-300 h-32 focus:border-indigo-500 outline-none transition-all" placeholder="Plak hier je code...">${val.code}</textarea>
            `;
            container.appendChild(div);
        };

        window.editSnippet = (id) => {
            const s = snippets.find(item => item._id === id);
            if (!s) return;
            document.getElementById('snippet-id').value = s._id;
            document.getElementById('title').value = s.title;
            document.getElementById('tags').value = s.tags.join(', ');
            document.getElementById('input-blocks-container').innerHTML = '';
            s.blocks.forEach(b => addInputBlock(b));
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('form-title').innerHTML = '<i class="fa-solid fa-pen-to-square text-blue-500"></i> Bewerken';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEdit = () => {
            document.getElementById('snippet-form').reset();
            document.getElementById('snippet-id').value = '';
            document.getElementById('input-blocks-container').innerHTML = '';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('form-title').innerHTML = '<i class="fa-solid fa-plus-circle text-indigo-500"></i> Nieuwe Snippet';
            addInputBlock();
        };

        window.deleteSnippet = async (id) => {
            if (confirm('Snippet definitief verwijderen?')) {
                await manager.gateway.deleteDocument(CONFIG.COLLECTION, id);
                await refreshData();
                showToast("Snippet verwijderd", true);
            }
        };

        function showToast(msg, isWarning = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.backgroundColor = isWarning ? '#EF4444' : '#10B981';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.setFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('.filter-item').forEach(btn => {
                btn.classList.remove('active', 'text-white');
                btn.classList.add('text-gray-400');
            });
            const active = document.getElementById(`filter-${f}`);
            active.classList.add('active', 'text-white');
            renderSnippets();
        };

        window.setTheme = (color) => {
            document.documentElement.style.setProperty('--bg-code', color);
            document.getElementById('theme-dropdown').classList.remove('show');
        };
        window.toggleThemeDropdown = () => document.getElementById('theme-dropdown').classList.toggle('show');

        init();
    </script>
</body>
</html>
